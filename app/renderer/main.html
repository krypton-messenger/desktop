<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' data:">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="main.css">
    <script src="common.js" charset="utf-8"></script>
    <title>Krypton Beta</title>
</head>

<body>
    <nav>
        <button class="material-icons" onclick="minimizeWindow()">minimize</button>
        <button class="material-icons" onclick="toggleMaximizeWindow()">crop_square</button>
        <button class="material-icons" id="closeWindow" onclick="closeWindow()">close</button>
    </nav>
    <main>
        <div id="sideMenu">
            <div id="sideMenuFocuser" onclick="toggleSideMenu()"></div>
            <div id="ownProfile">
                <div>
                    <span id="ownUserName"></span>
                    <button>
                        <span class="material-icons">edit</span>
                    </button>
                </div>
                <button id="toggleUI" onclick="toggleTheme()">
                    <span class="material-icons">brightness_high</span>
                </button>
            </div>
            <div id="sideMenuActions">

                <button onclick="">
                    <span class="material-icons">create</span>
                    New Chat
                </button>
                <button onclick="">
                    <span class="material-icons">group</span>
                    New Group
                </button>
                <button onclick="">
                    <span class="material-icons">settings</span>
                    Settings
                </button>
                <button onclick="logout()">
                    <span class="material-icons">logout</span>
                    Sign Out
                </button>
                <button onclick="debugMode()">
                    <span class="material-icons">code</span>Debug
                </button>
            </div>
            <div id="sideMenuFooter">
                <span>Krypton Desktop</span>
                <span>Beta Version</span>
            </div>
        </div>



        <div id="messageView">
            <div id="messageContainer"></div>
            <div id="contactInformation">
                <button onclick="deselectContacts()">
                    <i class="material-icons">arrow_back</i>
                </button>
                <span class="chatTitle">chat_title</span>
                <span class="lastSeen">just now</span>

                <button>
                    <i class="material-icons">search</i>
                </button>
                <button>
                    <i class="material-icons">more_vert</i>
                </button>
            </div>
            <div id="messageActionArea">

                <button>
                    <i class="material-icons">attach_file</i></button>
                <textarea id="messageContent" placeholder="Write a message..."></textarea>
                <button>
                    <i class="material-icons">schedule</i>
                </button>
                <button>
                    <i class="material-icons">send</i>
                </button>
            </div>
        </div>

        <div id="chatView">
            <div id="searchBar">
                <button id="menuOpener" onclick="toggleSideMenu()">
                    <div></div>
                    <div></div>
                    <div></div>
                </button>
                <div id="searchInputContainer">
                    <input type="text" placeholder="Search">
                    <button>
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>
            <div id="chatList"></div>
        </div>

        <div id="toastBarContainer"></div>

    </main>


    <script>
        const logout = () => {
            window.ipc.send('logout', {});
        }

        const toggleSideMenu = () => {
            document.getElementById('sideMenu').classList.toggle('open');
        }

        /*
         * @params data : <message Object> 
            {
                direction: "sent" || "recieved",
                chat_id: <hex-string> "bffbbca16e2284c5604d547d0f3fa72be128051c1100b3e053ad0179f7845fc7a35c4f05380f827e29118217bc836aef9f8a3fe2f968fa809f30a6e3968dd967",
                encryptionType: <string> "RSA-AES_CBC",
                timestamp: <iso-date-time-string> "2021-03-28T12:14:30.827Z", 
                verified: <bool> true,
                messageType: "text" || "file" || "image",
                message_id: 383864285,
                message: {
                    value: <string> "hello world",
                    quote: <bool> false || <quote Object> 
                        {
                            text: <string> "hello world",
                            username: <string> "username",
                            messageId: <int> 372869478
                        }
                }
            }   
         */
        const createMessageElement = (data) => {
            return new Promise((resolve, reject) => {


                let date = new Date(data.timestamp);

                let messageContainer = document.createElement("div");
                messageContainer.dataset.messageId = data.message_id;
                resolve(messageContainer);

                messageContainer.classList.add("message", data.direction ?? Math.random() > .5 ? "sent" : "recieved");
                messageContainer.dataset.timestampMinutes = pad(date.getMinutes(), 2);
                messageContainer.dataset.timestampHours = pad(date.getHours(), 2);
                messageContainer.dataset.timestamp = date.getTime();
                messageContainer.dataset.verified = data.verified;
                messageContainer.classList.add(data.messageType ?? "text");

                let messageContent = document.createElement("div");
                messageContent.classList.add("messageContent");
                messageContainer.appendChild(messageContent);

                switch (data.messageType) {
                    case "file":

                        let [title, fileId, rawSize, encryptedSize, mimeType] = data.message.value.split(":");

                        let contentElement = document.createElement("div");
                        contentElement.classList.add("file");
                        contentElement.dataset.title = title;
                        contentElement.dataset.fileId = fileId;
                        contentElement.dataset.rawSize = rawSize;
                        contentElement.dataset.encryptedSize = encryptedSize;
                        contentElement.dataset.mimeType = mimeType;

                        let fileTitle = document.createElement("span");
                        fileTitle.classList.add("fileTitle");
                        fileTitle.appendChild(document.createTextNode(title));
                        contentElement.appendChild(fileTitle);


                        let fileSize = document.createElement("span");
                        fileSize.classList.add("fileSize");
                        fileSize.appendChild(document.createTextNode(formatBytes(rawSize)));
                        contentElement.appendChild(fileSize);


                        messageContent.appendChild(contentElement);

                        break;
                    default:
                        let contentParagraph = document.createElement("p");
                        contentParagraph.appendChild(markdownConverter(data.message.value));
                        messageContent.appendChild(contentParagraph);
                        break;

                }

            });

        }

        const createChatTile = (data) => {
            let date = new Date(data.lastMessage.timestamp)

            let chatContainer = document.createElement("div");
            chatContainer.classList.add("chatContainer");
            chatContainer.dataset.lastMessageTime = date.getTime();
            chatContainer.dataset.chatid = data.lastMessage.chat_id;
            chatContainer.onclick = (e) => {
                deselectContacts(true);
                chatContainer.classList.add("selected");
                window.ipc.send('getmessages', {
                    chatid: data.chatid,
                    chatKey: data.chatKey,
                    offset: 0
                });
            };

            let profilePicture = document.createElement("div");
            profilePicture.classList.add("profilePicture");
            if (data.profilePicture) profilePicture.style.setProperty("--profilePicture", "url(" + data.profilePicture + ")");
            chatContainer.appendChild(profilePicture);

            let contactName = document.createElement("span");
            contactName.classList.add("contactName");
            contactName.appendChild(document.createTextNode(data.username));
            chatContainer.appendChild(contactName);

            let messagePreview = document.createElement("span");
            messagePreview.classList.add("messagePreview");
            switch (data.lastMessage.messageType) {
                case "file":
                    let attachFileSpan = document.createElement("span");
                    attachFileSpan.innerHTML = "attach_file";
                    attachFileSpan.classList.add("material-icons");
                    messagePreview.appendChild(attachFileSpan);

                    let fileName = document.createElement("span");
                    fileName.appendChild(document.createTextNode(data.lastMessage.message.value.split(":")[0]))
                    messagePreview.appendChild(fileName);
                    break;
                default:
                    messagePreview.appendChild(document.createTextNode(data.lastMessage.message.value));
                    break;
            }
            chatContainer.appendChild(messagePreview);

            let messageTime = document.createElement("span");
            messageTime.classList.add("messageTime");
            messageTime.appendChild(document.createTextNode(date.getHours, date.getMinutes));
            chatContainer.appendChild(messagePreview);

            return chatContainer
        }

        const sortChatTiles = target => {
            for (var i of [].slice.call(target.childNodes).sort((a, b) => {
                    return b.dataset.lastMessageTime - a.dataset.lastMessageTime
                })) {
                target.appendChild(i);
            }
        }
        const sortMessageElements = target => {
            for (var i of [].slice.call(target.childNodes).sort((a, b) => {
                    return b.dataset.timestamp - a.dataset.timestamp
                })) {
                target.appendChild(i);
            }
        }
        const deselectContacts = (loading) => {
            document.querySelectorAll(".selected.chatContainer").forEach((elmt) => {
                elmt.classList.remove("selected");
            });
            if (loading) {
                document.getElementById("messageView").classList.add("loading");
            } else {
                document.getElementById("messageView").classList.remove("loading");
            }
            document.getElementById("messageView").classList.remove("hasMessages");
            document.getElementById("messageContainer").innerHTML = "";
        }


        window.ipc.send('chatList', {
            request: true
        });

        window.ipc.send('ownProfile', {
            request: true
        });

        const showToast = (msg, opts) => {
            document.getElementById("toastBarContainer").appendChild(createToast(msg, opts));
        }

        window.ipc.listen(async (e, response) => {

            switch (response.trigger) {
                case "getmessages":
                    console.log("recieved message list");
                    if (!response.success) {
                        showToast(response.error.description, {
                            actions: [{
                                text: "Retry",
                                callback: () => {
                                    window.ipc.send('chatList', {
                                        request: true
                                    });
                                }
                            }]
                        });
                        return
                    }
                    document.getElementById("messageContainer").classList.remove("loading");
                    var messageComment = document.createElement("div");
                    messageComment.innerHTML = "March 12";
                    messageComment.classList.add("messageComment");
                    for (var i of response.data) {
                        if (Math.random() > .8) document.getElementById("messageContainer").appendChild(messageComment.cloneNode(true));
                        if (!document.querySelector('[data-message-id="' + i.message_id + '"]') && i.chat_id == document.querySelector(".selected.chatContainer").dataset.chatid) document.getElementById("messageContainer").appendChild(await createMessageElement(i));
                    }

                    document.getElementById("messageView").classList.remove("loading");
                    document.getElementById("messageView").classList.add("hasMessages");
                    sortMessageElements(document.getElementById("messageContainer"));
                    break;

                case "chatList":
                    console.log("recieved contact list");
                    if (!response.success) {
                        showToast(response.error.description, {
                            actions: [{
                                text: "Retry",
                                callback: () => {
                                    window.ipc.send('chatList', {
                                        request: true
                                    });
                                }
                            }]
                        });
                        return
                    }
                    for (var i of response.data) {
                        document.getElementById("chatList").appendChild(createChatTile(i));
                    }
                    sortChatTiles(document.getElementById("chatList"));
                    break;

                case "ownProfile":
                    console.log("recieved profile information");
                    if (!response.success) {
                        showToast(response.error.description, {
                            actions: [{
                                text: "Retry",
                                callback: () => {
                                    window.ipc.send('ownProfile', {
                                        request: true
                                    });
                                }
                            }]
                        });
                        return
                    }
                    document.getElementById("ownUserName").appendChild(document.createTextNode("@" + response.data.username));
                    if (response.data.profilePictureURI) document.getElementById("ownProfile").style.setProperty("--profilePicture", "url(" + response.data.profilePictureURI + ")");
                    break;
                default:
                    showToast("Unknown action: " + response.trigger)
                    break;
            }

        });

    </script>
</body>

</html>

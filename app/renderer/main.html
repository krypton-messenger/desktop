<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' data:">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="main.css">
    <script src="common.js" charset="utf-8"></script>
    <script src="md.js" charset="utf-8"></script>
    <script src="elements.js" charset="utf-8"></script>
    <title>Krypton Beta</title>
</head>

<body id="body">

    <nav>
        <button class="material-icons" onclick="minimizeWindow()">minimize</button>
        <button class="material-icons" onclick="toggleMaximizeWindow()">crop_square</button>
        <button class="material-icons" id="closeWindow" onclick="closeWindow()">close</button>
    </nav>
    <main>
        <div id="sideMenu" class="">
            <div id="sideMenuFocuser" onclick="toggleSideMenu()"></div>

            <div id="sideMenuActions">

                <button onclick="createChat()">
                    <span class="material-icons">create</span>
                    New Chat
                </button>
                <button onclick="noImplementation(true)">
                    <span class="material-icons">group</span>
                    New Group
                </button>
                <button onclick="showSettings()">
                    <span class="material-icons">settings</span>
                    Settings
                </button>
                <button onclick="logout()">
                    <span class="material-icons">logout</span>
                    Sign Out
                </button>
                <button onclick="debugMode()">
                    <span class="material-icons">code</span>Debug
                </button>
            </div>
            <div id="sideMenuFooter">
                <span>Krypton Desktop</span>
                <span>Beta Version</span>
                <button id="toggleUI" onclick="toggleTheme()">
                    <span class="material-icons">brightness_high</span>
                </button>
            </div>
        </div>



        <div id="messageView" class="">
            <div id="messageContainer" class=""></div>
            <div id="contactInformation">
                <button onclick="new ChatTile().deselectAll()">
                    <i class="material-icons">arrow_back</i>
                </button>
                <span class="chatTitle" id="chatTitle" onclick="noImplementation()">tim</span>
                <span class="chatInfo" onclick="noImplementation()"></span>
                <button onclick="noImplementation(true)">
                    <i class="material-icons">call</i>
                </button>
                <button onclick="noImplementation()">
                    <i class="material-icons">more_vert</i>
                </button>
            </div>
            <div id="messageActionArea">

                <button onclick="noImplementation()">
                    <i class="material-icons">attach_file</i></button>
                <textarea id="messageContent" placeholder="Write a message..."></textarea>
                <button onclick="noImplementation()">
                    <i class="material-icons">schedule</i>
                </button>
                <button onclick="sendMessage()">
                    <i class="material-icons">send</i>
                </button>
            </div>
            <div id="selectedMessageActionArea">

                <button>
                    <i class="material-icons">arrow_back</i>
                </button>
                <span id="selectedMessageCount">0</span>
                <button title="reply" onclick="noImplementation()">
                    <i class="material-icons">reply</i>
                </button>
                <button title="translate" onclick="noImplementation()">
                    <i class="material-icons">translate</i>
                </button>
                <button title="read aloud" onclick="noImplementation()">
                    <i class="material-icons">volume_up</i>
                </button>
                <button title="copy to clipboard" onclick="noImplementation()">
                    <i class="material-icons">content_copy</i>
                </button>
                <button title="forward" onclick="noImplementation()">
                    <i class="material-icons">send</i></button>
            </div>
        </div>

        <div id="chatView">
            <div id="searchBar">
                <button id="menuOpener" onclick="toggleSideMenu()" class="material-icons">menu</button>
                <div id="searchInputContainer">
                    <input type="text" placeholder="Search" id="searchInput">
                    <button onclick="clearSearchInput()" id="clearSearchInput">
                        <span class="material-icons">close</span>
                    </button>
                    <button onclick="document.querySelector('#searchBar input').focus()" id="showSearchInput">
                        <span class="material-icons">search</span>
                    </button>
                </div>
            </div>
            <div id="chatList"></div>
        </div>

        <div id="toastBarContainer"></div>
        <div id="popupContainer"></div>

    </main>


    <script>
        window.ipc.send("windowStateChange", "openDebug");

        window.onkeyup = (e) => {
            console.log(e);
            switch (e.code) {
                case "Escape":
                    switch (e.target.id) {
                        case "messageContent":
                            e.target.blur();
                            break;
                        case "messageView":
                        case "messageContainer":
                        case "contactInformation":
                        case "chatList":
                        case "body":
                        case "menuOpener":
                            if (document.getElementById('sideMenu').classList.contains("open")) toggleSideMenu()
                            else if (document.querySelector(".contextMenu")) new ContextMenu()
                                .removeAllContextMenus()
                            else if (document.querySelector(".selected.message")) document.querySelector(
                                ".selected.message").messageElement.deselectAll();
                            else new ChatTile().deselectAll();
                            break;

                        case "searchInput":
                            clearSearchInput();
                    }
                    break;
                case "Enter":
                case "NumpadEnter":
                    console.log(e.target.value);
                    if (e.target.id == "searchInput") search(e.target.value);
                case "Space":
                    if (e.target.type != "textarea" && e.target.type != "input") e.target.click();
                    else if (e.target.type == "textarea" && !e.shiftKey && e.key == "Enter") {
                        sendMessage()
                        e.preventDefault();
                    };
            }
        }

        const createChat = () => {
            let usernameSelector = document.createElement("input");
            usernameSelector.placeholder = "enter username";
            let chatPopup;
            chatPopup = new Popup(usernameSelector, {
                cancel: true,
                okButton: {
                    label: "Create Chat",
                    callback: () => {
                        let username = usernameSelector.value;
                        ipc.send("createChat", {
                            username
                        });
                    }
                }
            }).show();
        }

        const search = (value) => {
            window.ipc.send('search', {
                query: value
            });
        }
        const clearSearchInput = () => {
            document.getElementById("searchInput").value = "";
            document.getElementById("searchInput").blur();
        }

        const sendMessage = () => {
            window.ipc.send('sendmessage', {
                quote: window.quotedMessage,
                content: document.getElementById("messageContent").value,
                chatId: document.querySelector(".selected.chatContainer").dataset.chatid
            });
            document.getElementById("messageContent").value = "";
        }
        const noImplementation = serverside => {
            new Toast("This feature has not yet been implemented" + (serverside ? " on the server" :
                " on the client"), {
                timer: 2000
            });
        }
        const logout = () => {
            window.ipc.send('logout', {});
        }
        const toggleSideMenu = () => {
            document.getElementById('sideMenu').classList.toggle('open');
        }
        const sortMessageElements = target => {
            for (var i of [].slice.call(target.childNodes).sort((a, b) => {
                    return b.dataset.timestamp - a.dataset.timestamp
                })) {
                target.appendChild(i);
            }
        }
        const showSettings = () => {
            let items = {
                type: "div",
                content: [{
                    type: "span",
                    class: ["popupTitle"],
                    content: ["settings"]
                }, {
                    type: "div",
                    class: ["settingsEntry"],
                    content: [{
                        type: "span",
                        content: ["theme"]
                    }, {
                        type: "button",
                        class: ["material-icons"],
                        onclick: toggleTheme,
                        content: ["brightness_high"]
                    }, {
                        type: "button",
                        class: ["material-icons"],
                        content: ["expand_more"]
                    }]
                }]
            };

            let createItemElement = (data) => {
                let elmt = document.createElement(data.type ?? "div");
                if (data.class) elmt.classList.add(...data.class);
                if (data.onclick) elmt.onclick = data.onclick;
                for (var i of data.content ?? []) {
                    if (typeof (i) == "string") elmt.appendChild(document.createTextNode(i));
                    else elmt.appendChild(createItemElement(i));
                }
                return elmt;
            }

            let settingsContainer = createItemElement(items);

            new Popup(settingsContainer, {
                cancel: false,
                okButton: {
                    label: "ok"
                }
            }).show();
        }

        window.ipc.send('chatList', {
            request: true
        });
        window.ipc.send('ownProfile', {
            request: true
        });
        window.ipc.listen(async (e, response) => {
            console.log(e, response);
            switch (response.trigger) {
                case "getmessages":
                    console.log("recieved message list");
                    if (!response.success) {
                        new Toast(response.error.description, {
                            actions: [{
                                text: "Retry",
                                callback: () => {
                                    window.ipc.send('chatList', {
                                        request: true
                                    });
                                }
                            }]
                        });
                        return
                    }
                    document.getElementById("messageContainer").classList.remove("loading");
                    var messageComment = document.createElement("div");
                    messageComment.innerHTML = "March 12";
                    messageComment.classList.add("messageComment");
                    console.log("sample message", response.data[0]);
                    for (var i of response.data) {
                        if (!document.querySelector('[data-message-id="' + i.message_id + '"]') && i
                            .chat_id == document.querySelector(".selected.chatContainer").dataset.chatid)
                            new MessageElement(i, "getmessages").append();
                    }

                    document.getElementById("messageView").classList.remove("loading");
                    document.getElementById("messageView").classList.add("hasMessages");
                    sortMessageElements(document.getElementById("messageContainer"));
                    break;

                case "chatList":
                    console.log(response);
                    console.log("recieved contact list");
                    if (!response.success) {
                        new Toast(response.error.description, {
                            actions: [{
                                text: "Retry",
                                callback: () => {
                                    window.ipc.send('chatList', {
                                        request: true
                                    });
                                }
                            }]
                        });
                        return
                    }
                    if (response.data.length == 0) document.getElementById("chatList").classList.add(
                        "noEntries");
                    else document.getElementById("chatList").classList.remove("noEntries");

                    for (var i of response.data) {
                        let chatTile = new ChatTile(i);
                        document.getElementById("chatList").appendChild(chatTile.container);
                        console.log("appended Chattile");
                        chatTile.sortChatTiles();
                    }
                    break;

                case "ownProfile":
                    console.log("recieved profile information");
                    if (!response.success) {
                        new Toast(response.error.description, {
                            actions: [{
                                text: "Retry",
                                callback: () => {
                                    window.ipc.send('ownProfile', {
                                        request: true
                                    });
                                }
                            }]
                        });
                        return
                    }
                    document.getElementById("ownUserName").appendChild(document.createTextNode("@" +
                        response.data.username));
                    if (response.data.profilePictureURI) document.getElementById("ownProfile").style
                        .setProperty("--profilePicture", "url(" + response.data.profilePictureURI + ")");
                    break;

                case "downloadFile":
                    new Toast(response.data, {
                        timer: 2000
                    });
                    break;

                case "sendmessage":
                    if (!response.success) {
                        new Toast(response.error, {
                            timer: 2000
                        });
                    }
                    break;
                case "socket_disconnected":
                    new Toast(response.data, {
                        actions: [{
                            text: "Retry",
                            callback: () => {
                                window.ipc.send('connectSocket', {
                                    request: true
                                });
                            }
                        }]
                    });
                    break;
                case "socket_message":
                    for (let i of response.data) {
                        console.log("appending message i", i)
                        new MessageElement(i, "socket_message").append();
                    }
                    //                    new Toast("Recieved new message");
                    break;
                case "search":
                    console.log(response.data.result);
                    break;
                case "createChat":
                    if (!response.success) {
                        try {
                            document.querySelector(`[data-chatid='${response.chatId}']`).click();
                            document.getElementById('sideMenu').classList.remove('open');
                        } catch (_e) {
                            new Toast(response.data ?? response.error ? response.error.description :
                                "Error creating chat", {
                                    timer: 2000
                                });
                        }
                    }
                    break;

                default:
                    new Toast("Unknown action: " + response.trigger)
                    break;
            }

        });
        //document.body.appendChild(new main(2).container);
    </script>



</body>

</html>